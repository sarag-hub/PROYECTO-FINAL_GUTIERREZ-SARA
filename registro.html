<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro de Ejercicios</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    .form-container {
      margin:20px;
      padding:20px;
      border:1px solid #ccc;
      border-radius:8px;
      background:#f9f9f9;
    }
    .modal {
      display:none;
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      background:white;
      padding:20px;
      border-radius:8px;
      box-shadow:0 4px 6px rgba(0,0,0,0.2);
      z-index:1000;
    }
    .overlay {
      display:none;
      position:fixed;
      top:0; left:0;
      width:100%; height:100%;
      background:rgba(0,0,0,0.5);
      z-index:999;
    }
    #mensajeFlotante {
      display:none;
      position:fixed;
      top:50%;
      left:50%;
      transform:translate(-50%, -50%);
      padding:20px 30px;
      border-radius:8px;
      box-shadow:0 4px 6px rgba(0,0,0,0.2);
      font-weight:bold;
      background:#4caf50;
      color:white;
      z-index:2000;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="navbar-brand">üè• Rehabilitaci√≥n F√≠sica</div>
    <div class="navbar-links">
      <a href="index.html">Inicio</a>
      <a href="login.html">Cerrar Sesi√≥n</a>
    </div>
  </nav>

  <main style="padding:20px;">
    <h1>Registro de Ejercicios</h1>

    <!-- Formulario -->
    <div class="form-container">
      <form id="formRegistro">
        <label>Paciente:</label><br>
        <input type="text" id="paciente" required><br><br>

        <label>Ejercicio:</label><br>
        <input type="text" id="ejercicio" required><br><br>

        <label>Observaciones:</label><br>
        <textarea id="observaciones" required></textarea><br><br>

        <label>Fecha:</label><br>
        <input type="date" id="fecha" required><br><br>

        <button type="submit">Guardar</button>
      </form>
    </div>

    <!-- Bot√≥n mostrar tabla -->
    <button id="btnMostrarTabla" style="margin-top:20px;">üìã Mostrar tabla de registros</button>

    <!-- Tabla -->
    <div id="tablaRegistros" style="display:none; margin-top:20px;">
        <h2>Tabla de registros</h2>
        <table border="1" width="100%">
        <thead>
        <tr>
            <th>ID</th>
            <th>Paciente</th>
            <th>Ejercicio</th>
            <th>Observaciones</th>
            <th>Fecha</th>
        </tr>
        </thead>
        <tbody id="tablaBodyRegistros"></tbody>
        </table>
    </div>

    <!-- Overlay -->
    <div class="overlay" id="overlay"></div>


  </main>

  <script>
    // Guardar registro
    document.getElementById('formRegistro').addEventListener('submit', async (e) => {
    e.preventDefault();
    const paciente = document.getElementById('paciente').value;
    const ejercicio = document.getElementById('ejercicio').value;
     const observaciones = document.getElementById('observaciones').value;
    const fecha = document.getElementById('fecha').value;

    const resp = await fetch('/registro', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ paciente, ejercicio, observaciones, fecha })
  });
  const data = await resp.json();

  if (data.success) {
    // ‚úÖ limpiar campos
    document.getElementById('formRegistro').reset();
    // ‚úÖ mostrar mensaje
    mostrarMensaje("Registro exitoso", "success");
  } else {
    mostrarMensaje("Error: " + (data.error || "No autorizado"), "error");
  }
});


let rolUsuario = null;
let registroAEliminar = null;

// Mostrar tabla
document.getElementById('btnMostrarTabla').addEventListener('click', async () => {
  try {
    const res = await fetch('/registro');
    const registros = await res.json();
    const tbody = document.getElementById('tablaBodyRegistros');
    tbody.innerHTML = '';

    registros.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.id_registro}</td>
        <td>${r.paciente}</td>
        <td>${r.ejercicio}</td>
        <td>${r.observaciones}</td>
        <td>${r.fecha}</td>
        <td>
          ${rolUsuario === 'admin' || rolUsuario === 'fisioterapeuta' ? `
            <button onclick="abrirModalEditar(${r.id_registro}, '${r.ejercicio}', '${r.observaciones}', '${r.fecha}')">Editar</button>
            <button onclick="abrirModalEliminar(${r.id_registro})">Eliminar</button>
          ` : ''}
        </td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById('tablaRegistros').style.display = 'block';
  } catch (err) {
    console.error("Error al cargar registros:", err);
    mostrarMensaje("Error al cargar registros", "error");
  }
});

// Editar tabla
document.getElementById('formEditar').addEventListener('submit', async (e) => {
  e.preventDefault();
  const id = document.getElementById('editId').value;
  const ejercicio = document.getElementById('editEjercicio').value;
  const observaciones = document.getElementById('editObservaciones').value;
  const fecha = document.getElementById('editFecha').value;

  const resp = await fetch('/registro/' + id, {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ ejercicio, observaciones, fecha })
  });
  const data = await resp.json();

  if (data.success) {
    cerrarModalEditar();
    mostrarMensaje("‚úèÔ∏è Registro actualizado correctamente", "success");
    document.getElementById('btnMostrarTabla').click(); // refrescar tabla
  } else {
    mostrarMensaje("Error al actualizar: " + (data.error || "No autorizado"), "error");
  }
});

// Eliminar tabla
document.getElementById('confirmEliminar').addEventListener('click', async () => {
  if (registroAEliminar) {
    const resp = await fetch('/registro/' + registroAEliminar, { method: 'DELETE' });
    const data = await resp.json();

    if (data.success) {
      cerrarModalEliminar();
      mostrarMensaje("üóëÔ∏è Registro eliminado exitosamente", "success");
      document.getElementById('btnMostrarTabla').click(); // refrescar tabla
    } else {
      mostrarMensaje("Error al eliminar: " + (data.error || "No autorizado"), "error");
    }
  }
});




// -------- MODAL EDITAR --------
function abrirModalEditar(id, ejercicio, observaciones, fecha) {
  document.getElementById('editId').value = id;
  document.getElementById('editEjercicio').value = ejercicio;
  document.getElementById('editObservaciones').value = observaciones;
  document.getElementById('editFecha').value = fecha;
  document.getElementById('modalEditar').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}
function cerrarModalEditar() {
  document.getElementById('modalEditar').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}


// -------- MODAL ELIMINAR --------
function abrirModalEliminar(id) {
  registroAEliminar = id;
  document.getElementById('modalEliminar').style.display = 'block';
  document.getElementById('overlay').style.display = 'block';
}
function cerrarModalEliminar() {
  document.getElementById('modalEliminar').style.display = 'none';
  document.getElementById('overlay').style.display = 'none';
}
document.getElementById('confirmEliminar').addEventListener('click', async () => {
      if (pacienteAEliminar) {
        await fetch('/registro/' + pacienteAEliminar, { method: 'DELETE' });
        cerrarModalEliminar();
        cargarTabla();
        mostrarMensaje("üóëÔ∏è Datos eliminados exitosamente", "success");
      }
    });


 

// -------- MENSAJE FLOTANTE --------
function mostrarMensaje(texto, tipo="success") {
  const mensaje = document.getElementById('mensajeFlotante');
  mensaje.innerText = texto;
  if (tipo === "success") mensaje.style.background = "#4caf50";
  else if (tipo === "error") mensaje.style.background = "#f44336";
  else mensaje.style.background = "#2196f3";

  mensaje.style.display = "block";
  setTimeout(() => {
    mensaje.style.display = "none";
  }, 3000);
}

// -------- CONTROL DE ROLES --------
window.onload = async () => {
  const res = await fetch('/session');
  const data = await res.json();

  if (data.success) {
    rolUsuario = data.usuario.rol;
    if (rolUsuario === 'paciente') {
      document.getElementById('btnMostrarTabla').style.display = 'none';
    }
  }
};


    // Mensaje flotante
    function mostrarMensaje(texto, tipo="success") {
      const mensaje = document.getElementById('mensajeFlotante');
      mensaje.innerText = texto;
      if (tipo === "success") mensaje.style.background = "#4caf50";
      else if (tipo === "error") mensaje.style.background = "#f44336";
      else mensaje.style.background = "#2196f3";

      mensaje.style.display = "block";
      setTimeout(() => {
        mensaje.style.display = "none";
      }, 3000);
    }


  </script>
</body>
</html>

</html>
